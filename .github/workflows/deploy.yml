name: Despliegue Continuo a EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout del código
      uses: actions/checkout@v3

    - name: Desplegar en EC2 vía SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST_DNS }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # 1. ACTUALIZAR E INSTALAR DOCKER (Porque te faltaba esto)
          sudo apt-get update
          sudo apt-get install -y docker.io git
          
          # Arrancar Docker y darle permisos
          sudo systemctl start docker
          sudo systemctl enable docker
          
          # 2. CLONAR O ACTUALIZAR (Corregido el nombre de la carpeta)
          # El log dice que tu repo se llama 'proyecto_navidad'
          if [ -d "proyecto_navidad" ]; then
            cd proyecto_navidad
            git pull origin main
          else
            # IMPORTANTE: Asegúrate de que esta URL es la de TU repo real
            git clone https://github.com/FranJJL05/proyecto_navidad
            cd proyecto_navidad
          fi
          
          # 3. LIMPIEZA (Usamos sudo por si acaso)
          sudo docker stop tienda-container || true
          sudo docker rm tienda-container || true
          
          # 4. CONSTRUIR (Usamos sudo)
          sudo docker build -t tienda-img .
          
          # 5. ARRANCAR
          # Puerto 80 de Amazon -> Puerto 8080 del Docker Seguro
          sudo docker run -d -p 80:8080 --name tienda-container --restart unless-stopped tienda-img